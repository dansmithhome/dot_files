#! /bin/bash

# Configure Signals to work with Parallels.
# This requires:
#    - configuring a hostname, signals.local, in macOS /etc/hosts
#    - Seeding the SSO database for this signals.local domain
#
# 1. add "ip-addr signals.local" to /etc/hosts.  ip-addr is the
#    network interface ip-address.
# 2. start Signals
# 3. execute this script
# 4. connect from Parallels to signals.local:8000




MARIA_CONTAINER=$(docker ps -q --filter=name=maria)
SIGNALS_HOSTNAME=signals.local


# IPCONFIG_IP=$( ipconfig getifaddr en0 )
IPCONFIG_IP=$( ifconfig | grep inet\  | grep -v 127.0.0.1 | head -1 | awk '$1 == "inet" { print $2}' )
HOSTS_IP=$( awk '$2 == "signals.local" { print $1 }' /etc/hosts )

if [[ $IPCONFIG_IP != $HOSTS_IP ]]
then
    echo Inconsistent ip values.
    echo ipconfig: $IPCONFIG_IP
    echo /etc/hosts: $HOSTS_IP
    exit 1
fi


sudo docker exec -i -t ${MARIA_CONTAINER} /usr/bin/mysql -u root -poxygen --batch -e "update ssousers set user_tenant = \"${SIGNALS_HOSTNAME}\";" -e "update ssotenants set domain=\"${SIGNALS_HOSTNAME}\";" pkisso

